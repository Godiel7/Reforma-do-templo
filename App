// src/App.jsx
import React, { useState, useEffect } from 'react';
import { Calendar, Heart, Brain, Sparkles, DollarSign, Plus, Save, ChevronLeft, ChevronRight } from 'lucide-react';

const ChristianDisciplineApp = () => {
  const [activeTab, setActiveTab] = useState('rotina');
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [routineItems, setRoutineItems] = useState([]);
  const [newRoutine, setNewRoutine] = useState({ hora: '', atividade: '', tipo: 'devocional' });
  const [historicoDatas, setHistoricoDatas] = useState([]);
  const [toast, setToast] = useState(null);

  const [bodyMetrics, setBodyMetrics] = useState({
    energia: 5, qualidadeSono: 5, alimentacao: 5, hidratacao: 5,
    frequenciaExercicios: 5, cumprimentoRotina: 5, resistenciaFadiga: 5,
    forca: 5, flexibilidade: 5, coordenacao: 5, percepcao: 5,
    resistenciaExcessos: 5, persistencia: 5, capacidadeDizerNao: 5
  });
  
  const [spiritMetrics, setSpiritMetrics] = useState({
    amor: 5, alegria: 5, paz: 5, paciencia: 5, fidelidade: 5,
    mansidao: 5, bondade: 5, benignidade: 5, dominioProprio: 5
  });
  
  const [soulMetrics, setSoulMetrics] = useState({
    alegria: 5, esperanca: 5, confianca: 5, serenidade: 5,
    ansiedade: 5, medo: 5, raiva: 5, tristeza: 5, tedio: 5
  });

  const [decisionData, setDecisionData] = useState({
    description: '',
    alinhamento: [false, false, false, false],
    mordomia: [false, false, false, false],
    generosidade: [false, false, false],
    testemunho: [false, false, false],
    eternidade: [false, false, false]
  });
  const [decisoesSalvas, setDecisoesSalvas] = useState([]);

  // --- STORAGE LOCAL (funciona no navegador) ---
  const storage = {
    async get(key) {
      const item = localStorage.getItem(key);
      return item ? { value: item } : null;
    },
    async set(key, value) {
      localStorage.setItem(key, value);
    }
  };

  useEffect(() => {
    loadDataForDate(selectedDate);
  }, [selectedDate]);

  useEffect(() => {
    carregarHistorico();
    carregarDecisoes();
  }, []);

  const carregarDecisoes = async () => {
    try {
      const result = await storage.get('decisoes-lista');
      if (result) setDecisoesSalvas(JSON.parse(result.value));
    } catch (e) { console.log('Nenhuma decisão') }
  };

  const carregarHistorico = async () => {
    try {
      const result = await storage.get('historico-datas');
      if (result) {
        const datas = JSON.parse(result.value);
        if (Array.isArray(datas)) setHistoricoDatas(datas);
      }
    } catch (e) { console.log('Nenhum histórico') }
  };

  const loadDataForDate = async (date) => {
    const load = async (key, setter, fallback) => {
      try {
        const res = await storage.get(key + '-' + date);
        if (res) setter(JSON.parse(res.value));
        else setter(fallback);
      } catch { setter(fallback) }
    };

    load('routine', setRoutineItems, []);
    load('body', setBodyMetrics, { ...bodyMetrics });
    load('spirit', setSpiritMetrics, { ...spiritMetrics });
    load('soul', setSoulMetrics, { ...soulMetrics });
    load('decision', setDecisionData, { description: '', alinhamento: [false,false,false,false], mordomia: [false,false,false,false], generosidade: [false,false,false], testemunho: [false,false,false], eternidade: [false,false,false] });
  };

  const saveData = async () => {
    try {
      await Promise.all([
        storage.set('routine-' + selectedDate, JSON.stringify(routineItems)),
        storage.set('body-' + selectedDate, JSON.stringify(bodyMetrics)),
        storage.set('spirit-' + selectedDate, JSON.stringify(spiritMetrics)),
        storage.set('soul-' + selectedDate, JSON.stringify(soulMetrics))
      ]);

      // --- CORRIGIDO: salvar histórico ---
      let datas = [];
      const hist = await storage.get('historico-datas');
      if (hist && hist.value) {
        try { datas = JSON.parse(hist.value); } catch { datas = []; }
      }
      if (!datas.includes(selectedDate)) {
        datas.push(selectedDate);
        datas.sort((a, b) => new Date(b) - new Date(a));
        await storage.set('historico-datas', JSON.stringify(datas));
        setHistoricoDatas(datas);
      }

      showToast('Progresso salvo!', 'success');
    } catch (e) {
      showToast('Erro ao salvar', 'error');
    }
  };

  const salvarDecisao = async () => {
    if (!decisionData.description.trim()) return showToast('Descreva a decisão', 'error');
    const nova = { id: Date.now(), data: selectedDate, dataHora: new Date().toISOString(), ...decisionData };
    const lista = [nova, ...decisoesSalvas];
    await storage.set('decisoes-lista', JSON.stringify(lista));
    setDecisoesSalvas(lista);
    setDecisionData({ description: '', alinhamento: [false,false,false,false], mordomia: [false,false,false,false], generosidade: [false,false,false], testemunho: [false,false,false], eternidade: [false,false,false] });
    showToast('Decisão salva!', 'success');
  };

  const excluirDecisao = async (id) => {
    if (!confirm('Excluir?')) return;
    const nova = decisoesSalvas.filter(d => d.id !== id);
    await storage.set('decisoes-lista', JSON.stringify(nova));
    setDecisoesSalvas(nova);
  };

  const changeDate = (days) => {
    const d = new Date(selectedDate);
    d.setDate(d.getDate() + days);
    setSelectedDate(d.toISOString().split('T')[0]);
  };

  const formatDate = (d) => new Date(d).toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });

  const addRoutineItem = () => {
    if (newRoutine.hora && newRoutine.atividade) {
      const item = { ...newRoutine, id: Date.now(), concluida: false };
      setRoutineItems(prev => [...prev, item].sort((a,b) => a.hora.localeCompare(b.hora)));
      setNewRoutine({ hora: '', atividade: '', tipo: 'devocional' });
    }
  };

  const toggleRoutineItem = (id) => {
    setRoutineItems(prev => prev.map(i => i.id === id ? { ...i, concluida: !i.concluida } : i));
  };

  const removeRoutineItem = (id) => {
    setRoutineItems(prev => prev.filter(i => i.id !== id));
  };

  const showToast = (msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  const tipoColors = {
    devocional: 'bg-purple-100 text-purple-800',
    fisico: 'bg-green-100 text-green-800',
    trabalho: 'bg-blue-100 text-blue-800',
    estudo: 'bg-yellow-100 text-yellow-800',
    alimentacao: 'bg-orange-100 text-orange-800',
    entretenimento: 'bg-pink-100 text-pink-800',
    outro: 'bg-gray-100 text-gray-800'
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
      {toast && (
        <div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white shadow-lg animate-pulse z-50
          ${toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
          {toast.msg}
        </div>
      )}

      <div className="max-w-4xl mx-auto">
        <header className="text-center mb-8 pt-6">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Disciplina Cristã</h1>
          <p className="text-gray-600 italic">Disciplina-te a ti mesmo e à doutrina - 1 Timóteo 4:16</p>
        </header>

        {/* Navegação de Data */}
        <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
          <div className="flex items-center justify-between">
            <button onClick={() => changeDate(-1)} className="p-2 hover:bg-gray-100 rounded-lg"><ChevronLeft size={24} /></button>
            <div className="text-center flex-1">
              <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="text-lg font-semibold border-none bg-transparent" />
              <p className="text-sm text-gray-600">{formatDate(selectedDate)}</p>
            </div>
            <button onClick={() => changeDate(1)} className="p-2 hover:bg-gray-100 rounded-lg"><ChevronRight size={24} /></button>
          </div>
        </div>

        {/* Abas */}
        <div className="bg-white rounded-lg shadow-lg mb-6">
          <div className="flex border-b overflow-x-auto">
            {['rotina', 'corpo', 'espirito', 'alma', 'decisao', 'historico'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)} className={`px-6 py-4 font-medium ${activeTab === tab ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}`}>
                {tab === 'rotina' && <Calendar size={20} className="inline mr-2" />}Rotina
                {tab === 'corpo' && <Heart size={20} className="inline mr-2" />}Corpo
                {tab === 'espirito' && <Sparkles size={20} className="inline mr-2" />}Espírito
                {tab === 'alma' && <Brain size={20} className="inline mr-2" />}Alma
                {tab === 'decisao' && <DollarSign size={20} className="inline mr-2" />}Decisões
                {tab === 'historico' && 'Histórico'}
              </button>
            ))}
          </div>

          <div className="p-6">
            {/* --- ROTINA --- */}
            {activeTab === 'rotina' && (
              <div>
                <h2 className="text-2xl font-bold mb-4">Rotina Diária</h2>
                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input type="time" value={newRoutine.hora} onChange={e => setNewRoutine({...newRoutine, hora: e.target.value})} className="px-3 py-2 border rounded" />
                    <input type="text" placeholder="Atividade" value={newRoutine.atividade} onChange={e => setNewRoutine({...newRoutine, atividade: e.target.value})} className="px-3 py-2 border rounded" />
                    <select value={newRoutine.tipo} onChange={e => setNewRoutine({...newRoutine, tipo: e.target.value})} className="px-3 py-2 border rounded">
                      {Object.keys(tipoColors).map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                    <button onClick={addRoutineItem} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2"><Plus size={20} />Adicionar</button>
                  </div>
                </div>
                <div className="space-y-2">
                  {routineItems.map(item => (
                    <div key={item.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                      <input type="checkbox" checked={item.concluida} onChange={() => toggleRoutineItem(item.id)} className="w-5 h-5" />
                      <span className="font-mono text-sm w-16">{item.hora}</span>
                      <span className={item.concluida ? 'line-through text-gray-500 flex-1' : 'flex-1'}>{item.atividade}</span>
                      <span className={'px-2 py-1 rounded text-xs ' + tipoColors[item.tipo]}>{item.tipo}</span>
                      <button onClick={() => removeRoutineItem(item.id)} className="text-red-500 text-sm">Remover</button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* --- OUTRAS ABAS (corpo, espírito, alma, decisão) --- */}
            {activeTab === 'corpo' && <MetricasTab title="Corpo" metrics={bodyMetrics} setMetrics={setBodyMetrics} color="green" />}
            {activeTab === 'espirito' && <MetricasTab title="Espírito" metrics={spiritMetrics} setMetrics={setSpiritMetrics} color="purple" />}
            {activeTab === 'alma' && <MetricasTab title="Alma" metrics={soulMetrics} setMetrics={setSoulMetrics} color="yellow" />}

            {/* --- DECISÃO --- */}
            {activeTab === 'decisao' && (
              <div>
                <h2 className="text-2xl font-bold mb-4">Guia de Decisão</h2>
                <textarea placeholder="Descreva a decisão..." value={decisionData.description} onChange={e => setDecisionData({...decisionData, description: e.target.value})} className="w-full p-3 border rounded h-20 mb-6" />
                {/* Checklists aqui (simplificado por brevidade) */}
                <button onClick={salvarDecisao} className="bg-blue-600 text-white px-8 py-3 rounded flex items-center gap-2 mx-auto"><Save size={20} />Salvar Decisão</button>
              </div>
            )}

            {/* --- HISTÓRICO SIMPLES --- */}
            {activeTab === 'historico' && (
              <div>
                <h2 className="text-2xl font-bold mb-4">Histórico</h2>
                {historicoDatas.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">Nenhum registro</p>
                ) : (
                  <div className="space-y-3">
                    {historicoDatas.map(data => <ListaHistorico key={data} data={data} setSelectedDate={setSelectedDate} setActiveTab={setActiveTab} />)}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        <button onClick={saveData} className="bg-green-600 text-white px-8 py-3 rounded flex items-center gap-2 mx-auto shadow-lg">
          <Save size={20} /> Salvar Progresso
        </button>
      </div>
    </div>
  );
};

// Componentes auxiliares
const MetricasTab = ({ title, metrics, setMetrics, color }) => {
  return (
    <div>
      <h2 className="text-2xl font-bold mb-4">{title}</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {Object.entries(metrics).map(([key, value]) => (
          <div key={key} className="mb-4">
            <div className="flex justify-between mb-1">
              <label className="text-sm font-medium capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}</label>
              <span className="text-sm font-bold text-blue-600">{value}</span>
            </div>
            <input type="range" min="1" max="10" value={value} onChange={e => setMetrics({...metrics, [key]: +e.target.value})} className="w-full" />
          </div>
        ))}
      </div>
    </div>
  );
};

const ListaHistorico = ({ data, setSelectedDate, setActiveTab }) => {
  const [medias, setMedias] = useState({ body: 0, spirit: 0, soul: 0 });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const load = async () => {
      const storage = { get: async (k) => ({ value: localStorage.getItem(k) }) };
      const [b, s, a] = await Promise.all(['body', 'spirit', 'soul'].map(cat => storage.get(cat + '-' + data)));
      const calc = obj => obj.value ? Object.values(JSON.parse(obj.value)).reduce((a,b) => a+b, 0) / Object.keys(JSON.parse(obj.value)).length : 0;
      setMedias({ body: calc(b).toFixed(1), spirit: calc(s).toFixed(1), soul: calc(a).toFixed(1) });
      setLoading(false);
    };
    load();
  }, [data]);

  return (
    <div onClick={() => { setSelectedDate(data); setActiveTab('corpo'); }} className="p-4 bg-white border rounded-lg cursor-pointer hover:shadow">
      <div className="flex justify-between items-center">
        <p className="font-semibold">{new Date(data).toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'short' })}</p>
        {loading ? <p>Carregando...</p> : (
          <div className="flex gap-3 text-sm">
            <span className="text-green-600 font-bold">{medias.body}</span>
            <span className="text-purple-600 font-bold">{medias.spirit}</span>
            <span className="text-yellow-600 font-bold">{medias.soul}</span>
          </div>
        )}
      </div>
    </div>
  );
};

export default ChristianDisciplineApp;
